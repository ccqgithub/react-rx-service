import{Subject as e,EMPTY as t,of as s,Observable as i,from as a,zip as r,concat as n,BehaviorSubject as l}from"rxjs";import{tap as h,switchMap as o,catchError as d,concatMap as u,reduce as c,map as f}from"rxjs/operators";const m=/%[sdj%]/g;function p(e,...t){let s=0;const i=t.length;if("function"==typeof e)return e(...t);if("string"==typeof e){return e.replace(m,(e=>{if("%%"===e)return"%";if(s>=i)return e;switch(e){case"%s":case"%d":return t[s++];case"%j":try{return JSON.stringify(t[s++])}catch(a){return"[Circular]"}default:return e}}))}return e}function g(e,t){return null==e||(!("array"!==t||!Array.isArray(e)||e.length)||!(!function(e){return"string"===e||"url"===e||"hex"===e||"email"===e||"date"===e||"pattern"===e}(t)||"string"!=typeof e||e))}const y={email:/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,url:new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i"),hex:/^#?([a-f0-9]{6}|[a-f0-9]{3})$/i},v={integer:e=>v.number(e)&&parseInt(e,10)===e,float:e=>v.number(e)&&!v.integer(e),array:e=>Array.isArray(e),regexp(e){if(e instanceof RegExp)return!0;try{return!!new RegExp(e)}catch(t){return!1}},date:e=>"function"==typeof e.getTime&&"function"==typeof e.getMonth&&"function"==typeof e.getYear&&!isNaN(e.getTime()),number:e=>!isNaN(e)&&"number"==typeof e,object:e=>"object"==typeof e&&!v.array(e),method:e=>"function"==typeof e,email:e=>"string"==typeof e&&!!e.match(y.email)&&e.length<255,url:e=>"string"==typeof e&&!!e.match(y.url),hex:e=>"string"==typeof e&&!!e.match(y.hex)};var b={required:function(e,t,s,i){if(!e.required)return[];const a=[];return g(t,e.type)&&a.push(p(i.messages.required,i.fullField)),a},notWhitespace:function(e,t,s,i){if(!e.notWhitespace)return[];const a=[];return(/^\s+$/.test(t)||""===t)&&a.push(p(i.messages.notWhitespace,i.fullField)),a},type:function(e,t,s,i){const a=[],r=e.type;return r?(g(t,e.type)||(["integer","float","array","regexp","object","method","email","number","date","url","hex"].indexOf(r)>-1?v[r](t)||a.push(p(i.messages.types[r],i.fullField,r)):r&&typeof t!==r&&a.push(p(i.messages.types[r],i.fullField,r))),a):a},range:function(e,t,s,i){const a=[],r="number"==typeof e.len,n="number"==typeof e.min,l="number"==typeof e.max;if(!r&&!n&&!l)return a;const h=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;let o=t,d=null;const u="number"==typeof t,c="string"==typeof t,f=Array.isArray(t);return u?d="number":c?d="string":f&&(d="array"),d?(f&&(o=t.length),c&&(o=t.replace(h,"_").length),r?o!==e.len&&a.push(p(i.messages[d].len,i.fullField,e.len)):n&&!l&&o<e.min?a.push(p(i.messages[d].min,i.fullField,e.min)):l&&!n&&o>e.max?a.push(p(i.messages[d].max,i.fullField,e.max)):n&&l&&(o<e.min||o>e.max)&&a.push(p(i.messages[d].range,i.fullField,e.min,e.max)),a):a},enum:function(e,t,s,i){if(!e.enum||!Array.isArray(e.enum))return[];const a=[];return-1===e.enum.indexOf(t)&&a.push(p(i.messages.enum,i.fullField,e.enum.join(", "))),a},pattern:function(e,t,s,i){if(!e.pattern)return[];const a=[];if(e.pattern instanceof RegExp)e.pattern.lastIndex=0,e.pattern.test(t)||a.push(p(i.messages.pattern.mismatch,i.fullField,t,e.pattern));else if("string"==typeof e.pattern){new RegExp(e.pattern).test(t)||a.push(p(i.messages.pattern.mismatch,i.fullField,t,e.pattern))}return a}};const x={default:"Validation error on field %s",required:"%s is required",enum:"%s must be one of %s",notWhitespace:"%s cannot be empty",date:{format:"%s date %s is invalid for format %s",parse:"%s date could not be parsed, %s is invalid ",invalid:"%s date %s is invalid"},types:{string:"%s is not a %s",method:"%s is not a %s (function)",array:"%s is not an %s",object:"%s is not an %s",number:"%s is not a %s",date:"%s is not a %s",boolean:"%s is not a %s",integer:"%s is not an %s",float:"%s is not a %s",regexp:"%s is not a valid %s",email:"%s is not a valid %s",url:"%s is not a valid %s",hex:"%s is not a valid %s"},string:{len:"%s must be exactly %s characters",min:"%s must be at least %s characters",max:"%s cannot be longer than %s characters",range:"%s must be between %s and %s characters"},number:{len:"%s must equal %s",min:"%s cannot be less than %s",max:"%s cannot be greater than %s",range:"%s must be between %s and %s"},array:{len:"%s must be exactly %s in length",min:"%s cannot be less than %s in length",max:"%s cannot be greater than %s in length",range:"%s must be between %s and %s in length"},pattern:{match:"%s value %s does not match pattern %s"},clone(){const e=JSON.parse(JSON.stringify(this));return e.clone=this.clone,e}};class $ extends Error{constructor(e,t){super(e),this.field=t}}class F{constructor(t,s){this.waiting=null,this.disposers=[],this.fields=null,this.errors=[],this.validating=!1,this.touched=!1,this.dirty=!1,this.validate$=new e;const{ruleValue:i,rules:a=[],reducer:r=(e=>e)}=t,{namePath:n,form:l,parent:u}=s;this.ruleValue=i,this.rules=a,this.reducer=r,this.namePath=n,this.form=l,this.parent=u||null,this.setSchema(t);const c=this.validate$.pipe(h((()=>{this.validating=!0,this.dirty=!1;const e={};e.promise=new Promise((t=>{e.resolve=t})),this.waiting=e,this.form.onChangeStatus()})),o((()=>this.validateAll())),h((e=>{var t;this.validating=!1,this.errors=[...e],null===(t=this.waiting)||void 0===t||t.resolve(e),this.form.onChangeStatus()})),d(((e,t)=>t))).subscribe();this.disposers.push((()=>{c.unsubscribe()})),this.form.touched&&this.validate$.next()}get fieldErrors(){const e=this.fields||{};let t=[];return Object.keys(e).forEach((s=>{const{errors:i,fieldErrors:a}=e[s];t=[...t,...i,...a]})),t}get needValidate(){return this.form.canValidate&&(this.form.options.validateOnFieldTouched&&this.touched&&!this.waiting||this.dirty)}setTouch(){this.touched||(this.touched=!0,this.upTouch(),this.downTouch(),origin&&this.form.onChangeStatus())}upTouch(){var e;this.touched=!0,null===(e=this.parent)||void 0===e||e.upTouch()}downTouch(){this.touched=!0,this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].downTouch()}))}onChange(e){this.setTouch(),this.setDirty(),this.form.onUpdate(this.reducer(this.form.data,e))}setDirty(){this.dirty||(this.dirty=!0,this.upDirty(),this.downDirty())}upDirty(){var e;this.dirty=!0,null===(e=this.parent)||void 0===e||e.upDirty()}downDirty(){this.dirty=!0,this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].downDirty()}))}validate(e=!1){return this.waiting&&!this.dirty||(e?this.validate$.next():this.upValidate()),this.waiting.promise}upValidate(){var e;this.validate$.next(),null===(e=this.parent)||void 0===e||e.upValidate()}checkValidate(){this.needValidate&&this.validate$.next(),this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].checkValidate()}))}forceValidate(e=!1){return e?this.validate$.next():this.upValidate(),this.waiting.promise}updateSchema(e){const{ruleValue:t,rules:s=[]}=e;this.rules=s,this.ruleValue=t,this.setSchema(e)}dispose(){this.disposers.forEach((e=>{e()})),this.disposers=[],this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].dispose()}))}setSchema(e){const t={},s=e.fields;Array.isArray(s)?s.forEach(((e,s)=>{if(!e.key)throw new Error("Array field need a key property!");t[e.key]=Object.assign(Object.assign({},e),{index:`${s}`})})):"object"==typeof s&&null!==s&&Object.keys(s).forEach((e=>{t[e]=Object.assign(Object.assign({},s[e]),{key:e,index:e})}));const i=Object.keys(this.fields||{}),a=Object.keys(t);if(this.fields){const e=this.fields;i.forEach((t=>{-1===a.indexOf(t)&&(e[t].dispose(),delete e[t])}))}if(a.length?this.fields||(this.fields={}):this.fields=null,this.fields){const e=this.fields;a.forEach((s=>{-1===i.indexOf(s)?e[s]=new F(t[s],{parent:this,form:this.form,namePath:this.namePath?`${this.namePath}.${t[s].index}`:t[s].index,index:t[s].index}):e[s].updateSchema(t[s])}))}}validateRules(){const{ruleValue:e,rules:i,form:a}=this;if(!i.length)return t;const r=a.options.firstRuleError;let n=!1;return s(...i).pipe(u((i=>s("").pipe(o((()=>n&&r?t:this.validateRule(i,e,a.data))),h((e=>{e.length&&(n=!0)}))))),c(((e,t)=>e.concat(...t)),[]),f((e=>e.map((e=>new $(e,this.namePath))))))}validateRule(e,t,r){const n=[];["required","type","range","pattern","enum","notWhitespace"].forEach((s=>{const i=(e.messages||{})[s];let a=(0,b[s])(e,t,r,{messages:x,fullField:this.namePath});a.length&&i&&(a=[i]),n.push(...a)}));let l=null;if(e.validator){const n=e.validator(e,t,r,{messages:x,fullField:this.namePath});l=n instanceof i?n:n instanceof Promise?a(n):s(n)}return l?l.pipe(f((e=>n.concat(...e))),f((t=>e.message?[e.message]:t))):s(n.length&&e.message?[e.message]:n)}validateFields(){const e=this.fields||{},t=Object.keys(e).map((t=>a(e[t].validate(!0))));return r(...t).pipe(f((e=>e.reduce(((e,t)=>[...e,...t]),[]))))}validateAll(){return n(this.validateRules(),this.validateFields()).pipe(c(((e,t)=>e.concat(...t)),[]))}}class w{constructor(e,t,s={}){this.disposers=[],this.touched$$=new l(!1),this.validating$$=new l(!1),this.errors$$=new l([]);const{validateOnlyFormTouched:i=!1,validateOnFieldTouched:a=!1,firstRuleError:r=!0}=s;this.options={validateOnlyFormTouched:i,validateOnFieldTouched:a,firstRuleError:r},this.buildSchema=e,this.data$$=new l(t),this.formField=new F(this.getFormFieldSchema(t),{form:this,namePath:"",index:""}),this.fields$$=new l(this.formField.fields)}get data(){return this.data$$.value}get touched(){return this.touched$$.value}get validating(){return this.validating$$.value}get errors(){return this.errors$$.value}get fields(){return this.fields$$.value}get canValidate(){return!(!this.touched&&this.options.validateOnlyFormTouched)}getFormFieldSchema(e){const{buildSchema:t}=this;return{ruleValue:e,rules:[],fields:t(e),reducer:(e,t)=>t}}onUpdate(e){const t=Object.assign(Object.assign({},this.data),e),s=this.getFormFieldSchema(t);this.data$$.next(t),this.formField.updateSchema(s),this.onChangeStatus(),this.formField.checkValidate()}onChangeStatus(){const{fieldErrors:e}=this.formField;this.validating$$.next(this.formField.validating),this.errors$$.next([...e]),this.fields$$.next(Object.assign({},this.formField.fields))}reset(e){this.touched$$.next(!1),this.data$$.next(e),this.formField=new F(this.getFormFieldSchema(e),{form:this,namePath:"",index:""}),this.fields$$.next(Object.assign({},this.formField.fields)),this.errors$$.next([...this.formField.fieldErrors])}validate(){return!this.touched&&this.touched$$.next(!0),this.formField.validate()}dispose(){this.disposers.forEach((e=>{e()}))}}export{F as Field,w as Form,x as messages};
