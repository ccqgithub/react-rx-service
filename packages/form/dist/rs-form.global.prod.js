var RSForm=function(e,t){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var i=s(t);const{catchError:a,reduce:r,switchMap:n,concatMap:o,tap:h,map:l}=i.operators,u=/%[sdj%]/g;function d(e,...t){let s=0;const i=t.length;if("function"==typeof e)return e(...t);if("string"==typeof e){return e.replace(u,(e=>{if("%%"===e)return"%";if(s>=i)return e;switch(e){case"%s":case"%d":return t[s++];case"%j":try{return JSON.stringify(t[s++])}catch(a){return"[Circular]"}default:return e}}))}return e}function c(e,t){return null==e||(!("array"!==t||!Array.isArray(e)||e.length)||!(!function(e){return"string"===e||"url"===e||"hex"===e||"email"===e||"date"===e||"pattern"===e}(t)||"string"!=typeof e||e))}const f={email:/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,url:new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i"),hex:/^#?([a-f0-9]{6}|[a-f0-9]{3})$/i},m={integer:e=>m.number(e)&&parseInt(e,10)===e,float:e=>m.number(e)&&!m.integer(e),array:e=>Array.isArray(e),regexp(e){if(e instanceof RegExp)return!0;try{return!!new RegExp(e)}catch(t){return!1}},date:e=>"function"==typeof e.getTime&&"function"==typeof e.getMonth&&"function"==typeof e.getYear&&!isNaN(e.getTime()),number:e=>!isNaN(e)&&"number"==typeof e,object:e=>"object"==typeof e&&!m.array(e),method:e=>"function"==typeof e,email:e=>"string"==typeof e&&!!e.match(f.email)&&e.length<255,url:e=>"string"==typeof e&&!!e.match(f.url),hex:e=>"string"==typeof e&&!!e.match(f.hex)};var p={required:function(e,t,s,i){if(!e.required)return[];const a=[];return c(t,e.type)&&a.push(d(i.messages.required,i.fullField)),a},notWhitespace:function(e,t,s,i){if(!e.notWhitespace)return[];const a=[];return(/^\s+$/.test(t)||""===t)&&a.push(d(i.messages.notWhitespace,i.fullField)),a},type:function(e,t,s,i){const a=[],r=e.type;return r?(c(t,e.type)||(["integer","float","array","regexp","object","method","email","number","date","url","hex"].indexOf(r)>-1?m[r](t)||a.push(d(i.messages.types[r],i.fullField,r)):r&&typeof t!==r&&a.push(d(i.messages.types[r],i.fullField,r))),a):a},range:function(e,t,s,i){const a=[],r="number"==typeof e.len,n="number"==typeof e.min,o="number"==typeof e.max;if(!r&&!n&&!o)return a;const h=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;let l=t,u=null;const c="number"==typeof t,f="string"==typeof t,m=Array.isArray(t);return c?u="number":f?u="string":m&&(u="array"),u?(m&&(l=t.length),f&&(l=t.replace(h,"_").length),r?l!==e.len&&a.push(d(i.messages[u].len,i.fullField,e.len)):n&&!o&&l<e.min?a.push(d(i.messages[u].min,i.fullField,e.min)):o&&!n&&l>e.max?a.push(d(i.messages[u].max,i.fullField,e.max)):n&&o&&(l<e.min||l>e.max)&&a.push(d(i.messages[u].range,i.fullField,e.min,e.max)),a):a},enum:function(e,t,s,i){if(!e.enum||!Array.isArray(e.enum))return[];const a=[];return-1===e.enum.indexOf(t)&&a.push(d(i.messages.enum,i.fullField,e.enum.join(", "))),a},pattern:function(e,t,s,i){if(!e.pattern)return[];const a=[];if(e.pattern instanceof RegExp)e.pattern.lastIndex=0,e.pattern.test(t)||a.push(d(i.messages.pattern.mismatch,i.fullField,t,e.pattern));else if("string"==typeof e.pattern){new RegExp(e.pattern).test(t)||a.push(d(i.messages.pattern.mismatch,i.fullField,t,e.pattern))}return a}};const g={default:"Validation error on field %s",required:"%s is required",enum:"%s must be one of %s",notWhitespace:"%s cannot be empty",date:{format:"%s date %s is invalid for format %s",parse:"%s date could not be parsed, %s is invalid ",invalid:"%s date %s is invalid"},types:{string:"%s is not a %s",method:"%s is not a %s (function)",array:"%s is not an %s",object:"%s is not an %s",number:"%s is not a %s",date:"%s is not a %s",boolean:"%s is not a %s",integer:"%s is not an %s",float:"%s is not a %s",regexp:"%s is not a valid %s",email:"%s is not a valid %s",url:"%s is not a valid %s",hex:"%s is not a valid %s"},string:{len:"%s must be exactly %s characters",min:"%s must be at least %s characters",max:"%s cannot be longer than %s characters",range:"%s must be between %s and %s characters"},number:{len:"%s must equal %s",min:"%s cannot be less than %s",max:"%s cannot be greater than %s",range:"%s must be between %s and %s"},array:{len:"%s must be exactly %s in length",min:"%s cannot be less than %s in length",max:"%s cannot be greater than %s in length",range:"%s must be between %s and %s in length"},pattern:{match:"%s value %s does not match pattern %s"},clone(){const e=JSON.parse(JSON.stringify(this));return e.clone=this.clone,e}};class y extends Error{constructor(e,t){super(e),this.field=t}}class v{constructor(e,s){this.waiting=null,this.disposers=[],this.fields=null,this.errors=[],this.validating=!1,this.touched=!1,this.dirty=!1,this.validate$=new t.Subject;const{ruleValue:i,rules:r=[],reducer:o=(e=>e)}=e,{namePath:l,form:u,parent:d}=s;this.ruleValue=i,this.rules=r,this.reducer=o,this.namePath=l,this.form=u,this.parent=d||null,this.setSchema(e);const c=this.validate$.pipe(h((()=>{this.validating=!0,this.dirty=!1;const e={};e.promise=new Promise((t=>{e.resolve=t})),this.waiting=e,this.form.onChangeStatus()})),n((()=>this.validateAll())),h((e=>{this.validating=!1,this.errors=[...e],this.waiting?.resolve(e),this.form.onChangeStatus()})),a(((e,t)=>t))).subscribe();this.disposers.push((()=>{c.unsubscribe()})),this.form.touched&&this.validate$.next()}get fieldErrors(){const e=this.fields||{};let t=[];return Object.keys(e).forEach((s=>{const{errors:i,fieldErrors:a}=e[s];t=[...t,...i,...a]})),t}get needValidate(){return this.form.canValidate&&(this.form.options.validateOnFieldTouched&&this.touched&&!this.waiting||this.dirty)}setTouch(){this.touched||(this.touched=!0,this.upTouch(),this.downTouch(),origin&&this.form.onChangeStatus())}upTouch(){this.touched=!0,this.parent?.upTouch()}downTouch(){this.touched=!0,this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].downTouch()}))}onChange(e){this.setTouch(),this.setDirty(),this.form.onUpdate(this.reducer(this.form.data,e))}setDirty(){this.dirty||(this.dirty=!0,this.upDirty(),this.downDirty())}upDirty(){this.dirty=!0,this.parent?.upDirty()}downDirty(){this.dirty=!0,this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].downDirty()}))}validate(e=!1){return this.waiting&&!this.dirty||(e?this.validate$.next():this.upValidate()),this.waiting.promise}upValidate(){this.validate$.next(),this.parent?.upValidate()}checkValidate(){this.needValidate&&this.validate$.next(),this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].checkValidate()}))}forceValidate(e=!1){return e?this.validate$.next():this.upValidate(),this.waiting.promise}updateSchema(e){const{ruleValue:t,rules:s=[]}=e;this.rules=s,this.ruleValue=t,this.setSchema(e)}dispose(){this.disposers.forEach((e=>{e()})),this.disposers=[],this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].dispose()}))}setSchema(e){const t={},s=e.fields;Array.isArray(s)?s.forEach(((e,s)=>{if(!e.key)throw new Error("Array field need a key property!");t[e.key]={...e,index:`${s}`}})):"object"==typeof s&&null!==s&&Object.keys(s).forEach((e=>{t[e]={...s[e],key:e,index:e}}));const i=Object.keys(this.fields||{}),a=Object.keys(t);if(this.fields){const e=this.fields;i.forEach((t=>{-1===a.indexOf(t)&&(e[t].dispose(),delete e[t])}))}if(a.length?this.fields||(this.fields={}):this.fields=null,this.fields){const e=this.fields;a.forEach((s=>{-1===i.indexOf(s)?e[s]=new v(t[s],{parent:this,form:this.form,namePath:this.namePath?`${this.namePath}.${t[s].index}`:t[s].index,index:t[s].index}):e[s].updateSchema(t[s])}))}}validateRules(){const{ruleValue:e,rules:s,form:i}=this;if(!s.length)return t.EMPTY;const a=i.options.firstRuleError;let u=!1;return t.of(...s).pipe(o((s=>t.of("").pipe(n((()=>u&&a?t.EMPTY:this.validateRule(s,e,i.data))),h((e=>{e.length&&(u=!0)}))))),r(((e,t)=>e.concat(...t)),[]),l((e=>e.map((e=>new y(e,this.namePath))))))}validateRule(e,s,i){const a=[];["required","type","range","pattern","enum","notWhitespace"].forEach((t=>{const r=(e.messages||{})[t];let n=(0,p[t])(e,s,i,{messages:g,fullField:this.namePath});n.length&&r&&(n=[r]),a.push(...n)}));let r=null;if(e.validator){const a=e.validator(e,s,i,{messages:g,fullField:this.namePath});r=a instanceof t.Observable?a:a instanceof Promise?t.from(a):t.of(a)}return r?r.pipe(l((e=>a.concat(...e))),l((t=>e.message?[e.message]:t))):t.of(a.length&&e.message?[e.message]:a)}validateFields(){const e=this.fields||{},s=Object.keys(e).map((s=>t.from(e[s].validate(!0))));return t.zip(...s).pipe(l((e=>e.reduce(((e,t)=>[...e,...t]),[]))))}validateAll(){return t.concat(this.validateRules(),this.validateFields()).pipe(r(((e,t)=>e.concat(...t)),[]))}}return e.Field=v,e.Form=class{constructor(e,s,i={}){this.disposers=[],this.touched$$=new t.BehaviorSubject(!1),this.validating$$=new t.BehaviorSubject(!1),this.errors$$=new t.BehaviorSubject([]);const{validateOnlyFormTouched:a=!1,validateOnFieldTouched:r=!1,firstRuleError:n=!0}=i;this.options={validateOnlyFormTouched:a,validateOnFieldTouched:r,firstRuleError:n},this.buildSchema=e,this.data$$=new t.BehaviorSubject(s),this.formField=new v(this.getFormFieldSchema(s),{form:this,namePath:"",index:""}),this.fields$$=new t.BehaviorSubject(this.formField.fields)}get data(){return this.data$$.value}get touched(){return this.touched$$.value}get validating(){return this.validating$$.value}get errors(){return this.errors$$.value}get fields(){return this.fields$$.value}get canValidate(){return!(!this.touched&&this.options.validateOnlyFormTouched)}getFormFieldSchema(e){const{buildSchema:t}=this;return{ruleValue:e,rules:[],fields:t(e),reducer:(e,t)=>t}}onUpdate(e){const t={...this.data,...e},s=this.getFormFieldSchema(t);this.data$$.next(t),this.formField.updateSchema(s),this.onChangeStatus(),this.formField.checkValidate()}onChangeStatus(){const{fieldErrors:e}=this.formField;this.validating$$.next(this.formField.validating),this.errors$$.next([...e]),this.fields$$.next({...this.formField.fields})}reset(e){this.touched$$.next(!1),this.data$$.next(e),this.formField=new v(this.getFormFieldSchema(e),{form:this,namePath:"",index:""}),this.fields$$.next({...this.formField.fields}),this.errors$$.next([...this.formField.fieldErrors])}validate(){return!this.touched&&this.touched$$.next(!0),this.formField.validate()}dispose(){this.disposers.forEach((e=>{e()}))}},e.messages=g,Object.defineProperty(e,"__esModule",{value:!0}),e}({},rxjs);
