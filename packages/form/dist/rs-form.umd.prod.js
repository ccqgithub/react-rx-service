var e,t;e=this,t=function(e,t,s){const i=/%[sdj%]/g;function a(e,...t){let s=0;const a=t.length;return"function"==typeof e?e(...t):"string"==typeof e?e.replace(i,(e=>{if("%%"===e)return"%";if(s>=a)return e;switch(e){case"%s":case"%d":return t[s++];case"%j":try{return JSON.stringify(t[s++])}catch(i){return"[Circular]"}default:return e}})):e}function r(e,t){return null==e||!("array"!==t||!Array.isArray(e)||e.length)||!(!function(e){return"string"===e||"url"===e||"hex"===e||"email"===e||"date"===e||"pattern"===e}(t)||"string"!=typeof e||e)}const n={email:/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,url:new RegExp("^(?!mailto:)(?:(?:http|https|ftp)://|//)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i"),hex:/^#?([a-f0-9]{6}|[a-f0-9]{3})$/i},o={integer:e=>o.number(e)&&parseInt(e,10)===e,float:e=>o.number(e)&&!o.integer(e),array:e=>Array.isArray(e),regexp(e){if(e instanceof RegExp)return!0;try{return!!new RegExp(e)}catch(t){return!1}},date:e=>"function"==typeof e.getTime&&"function"==typeof e.getMonth&&"function"==typeof e.getYear&&!isNaN(e.getTime()),number:e=>!isNaN(e)&&"number"==typeof e,object:e=>"object"==typeof e&&!o.array(e),method:e=>"function"==typeof e,email:e=>"string"==typeof e&&!!e.match(n.email)&&e.length<255,url:e=>"string"==typeof e&&!!e.match(n.url),hex:e=>"string"==typeof e&&!!e.match(n.hex)};var h={required:function(e,t,s,i){if(!e.required)return[];const n=[];return r(t,e.type)&&n.push(a(i.messages.required,i.fullField)),n},notWhitespace:function(e,t,s,i){if(!e.notWhitespace)return[];const r=[];return(/^\s+$/.test(t)||""===t)&&r.push(a(i.messages.notWhitespace,i.fullField)),r},type:function(e,t,s,i){const n=[],h=e.type;return h?(r(t,e.type)||(["integer","float","array","regexp","object","method","email","number","date","url","hex"].indexOf(h)>-1?o[h](t)||n.push(a(i.messages.types[h],i.fullField,h)):h&&typeof t!==h&&n.push(a(i.messages.types[h],i.fullField,h))),n):n},range:function(e,t,s,i){const r=[],n="number"==typeof e.len,o="number"==typeof e.min,h="number"==typeof e.max;if(!n&&!o&&!h)return r;const l=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;let d=t,u=null;const c="number"==typeof t,f="string"==typeof t,m=Array.isArray(t);return c?u="number":f?u="string":m&&(u="array"),u?(m&&(d=t.length),f&&(d=t.replace(l,"_").length),n?d!==e.len&&r.push(a(i.messages[u].len,i.fullField,e.len)):o&&!h&&d<e.min?r.push(a(i.messages[u].min,i.fullField,e.min)):h&&!o&&d>e.max?r.push(a(i.messages[u].max,i.fullField,e.max)):o&&h&&(d<e.min||d>e.max)&&r.push(a(i.messages[u].range,i.fullField,e.min,e.max)),r):r},enum:function(e,t,s,i){if(!e.enum||!Array.isArray(e.enum))return[];const r=[];return-1===e.enum.indexOf(t)&&r.push(a(i.messages.enum,i.fullField,e.enum.join(", "))),r},pattern:function(e,t,s,i){if(!e.pattern)return[];const r=[];return e.pattern instanceof RegExp?(e.pattern.lastIndex=0,e.pattern.test(t)||r.push(a(i.messages.pattern.mismatch,i.fullField,t,e.pattern))):"string"==typeof e.pattern&&(new RegExp(e.pattern).test(t)||r.push(a(i.messages.pattern.mismatch,i.fullField,t,e.pattern))),r}};const l={default:"Validation error on field %s",required:"%s is required",enum:"%s must be one of %s",notWhitespace:"%s cannot be empty",date:{format:"%s date %s is invalid for format %s",parse:"%s date could not be parsed, %s is invalid ",invalid:"%s date %s is invalid"},types:{string:"%s is not a %s",method:"%s is not a %s (function)",array:"%s is not an %s",object:"%s is not an %s",number:"%s is not a %s",date:"%s is not a %s",boolean:"%s is not a %s",integer:"%s is not an %s",float:"%s is not a %s",regexp:"%s is not a valid %s",email:"%s is not a valid %s",url:"%s is not a valid %s",hex:"%s is not a valid %s"},string:{len:"%s must be exactly %s characters",min:"%s must be at least %s characters",max:"%s cannot be longer than %s characters",range:"%s must be between %s and %s characters"},number:{len:"%s must equal %s",min:"%s cannot be less than %s",max:"%s cannot be greater than %s",range:"%s must be between %s and %s"},array:{len:"%s must be exactly %s in length",min:"%s cannot be less than %s in length",max:"%s cannot be greater than %s in length",range:"%s must be between %s and %s in length"},pattern:{match:"%s value %s does not match pattern %s"},clone(){const e=JSON.parse(JSON.stringify(this));return e.clone=this.clone,e}};class d extends Error{constructor(e,t){super(e),this.field=t}}class u{constructor(e,i){this.waiting=null,this.disposers=[],this.fields=null,this.errors=[],this.validating=!1,this.touched=!1,this.dirty=!1,this.validate$=new t.Subject;const{ruleValue:a,rules:r=[],reducer:n=(e=>e)}=e,{namePath:o,form:h,parent:l}=i;this.ruleValue=a,this.rules=r,this.reducer=n,this.namePath=o,this.form=h,this.parent=l||null,this.setSchema(e);const d=this.validate$.pipe(s.tap((()=>{this.validating=!0,this.dirty=!1;const e={};e.promise=new Promise((t=>{e.resolve=t})),this.waiting=e,this.form.onChangeStatus()})),s.switchMap((()=>this.validateAll())),s.tap((e=>{var t;this.validating=!1,this.errors=[...e],null===(t=this.waiting)||void 0===t||t.resolve(e),this.form.onChangeStatus()})),s.catchError(((e,t)=>t))).subscribe();this.disposers.push((()=>{d.unsubscribe()})),this.form.touched&&this.validate$.next()}get fieldErrors(){const e=this.fields||{};let t=[];return Object.keys(e).forEach((s=>{const{errors:i,fieldErrors:a}=e[s];t=[...t,...i,...a]})),t}get needValidate(){return this.form.canValidate&&(this.form.options.validateOnFieldTouched&&this.touched&&!this.waiting||this.dirty)}setTouch(){this.touched||(this.touched=!0,this.upTouch(),this.downTouch(),origin&&this.form.onChangeStatus())}upTouch(){var e;this.touched=!0,null===(e=this.parent)||void 0===e||e.upTouch()}downTouch(){this.touched=!0,this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].downTouch()}))}onChange(e){this.setTouch(),this.setDirty(),this.form.onUpdate(this.reducer(this.form.data,e))}setDirty(){this.dirty||(this.dirty=!0,this.upDirty(),this.downDirty())}upDirty(){var e;this.dirty=!0,null===(e=this.parent)||void 0===e||e.upDirty()}downDirty(){this.dirty=!0,this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].downDirty()}))}validate(e=!1){return this.waiting&&!this.dirty||(e?this.validate$.next():this.upValidate()),this.waiting.promise}upValidate(){var e;this.validate$.next(),null===(e=this.parent)||void 0===e||e.upValidate()}checkValidate(){this.needValidate&&this.validate$.next(),this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].checkValidate()}))}forceValidate(e=!1){return e?this.validate$.next():this.upValidate(),this.waiting.promise}updateSchema(e){const{ruleValue:t,rules:s=[]}=e;this.rules=s,this.ruleValue=t,this.setSchema(e)}dispose(){this.disposers.forEach((e=>{e()})),this.disposers=[],this.fields&&Object.keys(this.fields).forEach((e=>{this.fields[e].dispose()}))}setSchema(e){const t={},s=e.fields;Array.isArray(s)?s.forEach(((e,s)=>{if(!e.key)throw new Error("Array field need a key property!");t[e.key]=Object.assign(Object.assign({},e),{index:`${s}`})})):"object"==typeof s&&null!==s&&Object.keys(s).forEach((e=>{t[e]=Object.assign(Object.assign({},s[e]),{key:e,index:e})}));const i=Object.keys(this.fields||{}),a=Object.keys(t);if(this.fields){const e=this.fields;i.forEach((t=>{-1===a.indexOf(t)&&(e[t].dispose(),delete e[t])}))}if(a.length?this.fields||(this.fields={}):this.fields=null,this.fields){const e=this.fields;a.forEach((s=>{-1===i.indexOf(s)?e[s]=new u(t[s],{parent:this,form:this.form,namePath:this.namePath?`${this.namePath}.${t[s].index}`:t[s].index,index:t[s].index}):e[s].updateSchema(t[s])}))}}validateRules(){const{ruleValue:e,rules:i,form:a}=this;if(!i.length)return t.EMPTY;const r=a.options.firstRuleError;let n=!1;return t.of(...i).pipe(s.concatMap((i=>t.of("").pipe(s.switchMap((()=>n&&r?t.EMPTY:this.validateRule(i,e,a.data))),s.tap((e=>{e.length&&(n=!0)}))))),s.reduce(((e,t)=>e.concat(...t)),[]),s.map((e=>e.map((e=>new d(e,this.namePath))))))}validateRule(e,i,a){const r=[];["required","type","range","pattern","enum","notWhitespace"].forEach((t=>{const s=(e.messages||{})[t];let n=(0,h[t])(e,i,a,{messages:l,fullField:this.namePath});n.length&&s&&(n=[s]),r.push(...n)}));let n=null;if(e.validator){const s=e.validator(e,i,a,{messages:l,fullField:this.namePath});n=s instanceof t.Observable?s:s instanceof Promise?t.from(s):t.of(s)}return n?n.pipe(s.map((e=>r.concat(...e))),s.map((t=>e.message?[e.message]:t))):t.of(r.length&&e.message?[e.message]:r)}validateFields(){const e=this.fields||{},i=Object.keys(e).map((s=>t.from(e[s].validate(!0))));return t.zip(...i).pipe(s.map((e=>e.reduce(((e,t)=>[...e,...t]),[]))))}validateAll(){return t.concat(this.validateRules(),this.validateFields()).pipe(s.reduce(((e,t)=>e.concat(...t)),[]))}}e.Field=u,e.Form=class{constructor(e,s,i={}){this.disposers=[],this.touched$$=new t.BehaviorSubject(!1),this.validating$$=new t.BehaviorSubject(!1),this.errors$$=new t.BehaviorSubject([]);const{validateOnlyFormTouched:a=!1,validateOnFieldTouched:r=!1,firstRuleError:n=!0}=i;this.options={validateOnlyFormTouched:a,validateOnFieldTouched:r,firstRuleError:n},this.buildSchema=e,this.data$$=new t.BehaviorSubject(s),this.formField=new u(this.getFormFieldSchema(s),{form:this,namePath:"",index:""}),this.fields$$=new t.BehaviorSubject(this.formField.fields)}get data(){return this.data$$.value}get touched(){return this.touched$$.value}get validating(){return this.validating$$.value}get errors(){return this.errors$$.value}get fields(){return this.fields$$.value}get canValidate(){return!(!this.touched&&this.options.validateOnlyFormTouched)}getFormFieldSchema(e){const{buildSchema:t}=this;return{ruleValue:e,rules:[],fields:t(e),reducer:(e,t)=>t}}onUpdate(e){const t=Object.assign(Object.assign({},this.data),e),s=this.getFormFieldSchema(t);this.data$$.next(t),this.formField.updateSchema(s),this.onChangeStatus(),this.formField.checkValidate()}onChangeStatus(){const{fieldErrors:e}=this.formField;this.validating$$.next(this.formField.validating),this.errors$$.next([...e]),this.fields$$.next(Object.assign({},this.formField.fields))}reset(e){this.touched$$.next(!1),this.data$$.next(e),this.formField=new u(this.getFormFieldSchema(e),{form:this,namePath:"",index:""}),this.fields$$.next(Object.assign({},this.formField.fields)),this.errors$$.next([...this.formField.fieldErrors])}validate(){return!this.touched&&this.touched$$.next(!0),this.formField.validate()}dispose(){this.disposers.forEach((e=>{e()}))}},e.messages=l,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define(["exports","rxjs","rxjs/operators"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).RSForm={},e.rxjs,e.rxjs.operators);
